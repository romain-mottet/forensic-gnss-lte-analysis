# Distance Estimation from LTE Signal Measurements

## 1. Project Overview
This repository contains the implementation of a machine learning pipeline designed to estimate the distance between a user equipment (UE) and its serving (or neighboring) LTE cell tower. This work serves as a core component of my Master's Thesis.

The goal is to derive an empirical propagation model that predicts the distance $d$ based on observable radio signal features (RSRP, RSRQ, EARFCN, etc.). The pipeline handles data ingestion, ground-truth association, feature engineering, and rigorous cross-validation to benchmark various model architectures.

In addition to evaluation, the pipeline now automatically exports the best-performing model formula for each context as a production-ready JSON file.

## 2. Repository Structure

The project follows a modular structure to separate data contexts, source code, and experimental results.

```
project_root/
├── data/                       # Input datasets organized by context
│   ├── tower/                  # Ground truth tower data
│   │   ├── towers.json         # Primary mapping: (PCI, EARFCN) -> (Lat, Lon)
│   │   └── pci.json            # Fallback mapping: PCI -> (Lat, Lon)
│   ├── waha/                   # Context 1: 'waha'
│   │   └── parsed_*.csv        # Measurement data files
│   ├── lln/                    # Context 2: 'lln'
│   │   └── context.json        # Context-specific configuration overrides
│   └── ...
├── src/                        # Source code
│   ├── distance_model.py       # Unified pipeline (linear + nonlinear variants)
│   └── export_formula.py       # JSON export utility for best models
├── result/                     # Generated CSV artifacts and JSON formulas
├── repport/                    # Generated textual summary reports
└── main.py                     # CLI Entry point
```

## 3. Data Provenance and Preprocessing

### 3.1. Input Data
The raw measurement data is ingested in the form of CSV files (`parsed_*_city.csv`).
*   **Source**: These files are generated by an external parsing utility [Reference to be added in Thesis] which processes raw drive-test logs.
*   **Format**: Each row represents a timestamped measurement containing GPS coordinates of the receiver (`Latitude`, `Longitude`) and radio metrics (`RSRP`, `RSRQ`, `PCI`, `EARFCN`) for the serving cell and potentially several neighbor cells.

### 3.2. Ground Truth Association (Tower Joining)
To train the distance model, each measurement is paired with the geographical coordinates of the transmitting tower. This is achieved via a join operation:
1.  **Primary Key**: `(PCI, EARFCN)` — The pipeline attempts to match the Physical Cell ID and Frequency to a unique tower in `data/tower/towers.json`.
2.  **Fallback (Optional)**: If configured, unmatched entries can fallback to a `PCI`-only match using `data/tower/pci.json`.

Data points that cannot be associated with a known tower location are flagged as "unmatched" and excluded from training, but logged to help improve the tower database.

## 4. Mathematical Methodology

### 4.1. Model Formulation
The distance estimation is framed as a regression problem. Inspired by the log-distance path loss model, we target the logarithm of the distance rather than the raw distance to stabilize variance and strictly enforce positive predictions.

**Target Variable:**
$$ y = \log_{10}(d_{\text{true}}) $$
where $d_{\text{true}}$ is the Haversine distance in meters between the phone and the tower.

**Predictive Model:**
We employ a linear-in-parameters regression model.
For the **Baseline** configuration:
$$ \hat{y} = \beta_0 + \beta_1 \cdot \text{RSRP} + \beta_2 \cdot \text{RSRQ} + \beta_3 \cdot \text{EARFCN}_k + \epsilon $$

For the **Nonlinear** (Expanded) configuration, we introduce polynomial and interaction terms to capture complex propagation effects:
$$ \hat{y} = \beta_0 + \sum \beta_i x_i + \sum \beta_{ij} x_i^2 + \sum \gamma_{ij} (x_i \cdot x_j) $$
Key features include:
*   `earfcn_k`: Scaled frequency ($\text{EARFCN} / 1000$).
*   `rsrp_sq`, `rsrq_sq`: Quadratic signal terms.
*   `rsrp_x_earfcnk`: Interaction between signal strength and frequency band.

**Inference:**
The final estimated distance $\hat{d}$ is recovered via:
$$ \hat{d} = 10^{\hat{y}} $$

### 4.2. Evaluation Metrics
Models are evaluated using **Leave-One-File-Out (LOFO) Cross-Validation** to ensure the model generalizes to unseen drive-test segments. We report the following metrics:

*   **Mean Absolute Error (MAE):**
    $$ \text{MAE} = \frac{1}{N} \sum_{i=1}^{N} | d_i - \hat{d}_i | $$
*   **Root Mean Squared Error (RMSE):**
    $$ \text{RMSE} = \sqrt{ \frac{1}{N} \sum_{i=1}^{N} (d_i - \hat{d}_i)^2 } $$
*   **Mean Absolute Percentage Error (MAPE):**
    $$ \text{MAPE} = \frac{100\%}{N} \sum_{i=1}^{N} \left| \frac{d_i - \hat{d}_i}{d_i} \right| $$

## 5. Usage

### 5.1. Environment
Ensure you have a Python 3 environment with `numpy` and `pandas` installed.

### 5.2. Running the Pipeline
The `main.py` script serves as the unified entry point. It accepts the context name (folder name inside `data/`) as a required argument.

**Standard Run (Baseline Models):**
```bash
python main.py waha
python main.py lln
```

**Nonlinear Run (Feature Expansion):**
To run the analysis with polynomial and interaction features (saved with `_nonlinear` suffix):
```bash
python main.py waha --nonlinear
```

### 5.3. Configuration (`context.json`)
You can customize the pipeline for specific datasets by placing a `context.json` file in the dataset folder (e.g., `data/lln/context.json`).

```json
{
  "csv_glob": "parsed_*_city.csv",    // Pattern to match input files
  "towers_path": "towers.json",       // Path relative to data/tower/ or absolute
  "use_pci_fallback": false,          // Enable PCI-only matching if exact match fails
  "max_neighbors": 18,                // Max neighbors to process per timestamp
  "keep_only_lte_neighbors": true     // Filter out non-LTE technologies
}
```

## 6. Outputs
Results are saved to the `result/` and `repport/` directories, preserving the context hierarchy.

*   `repport/<context>/summary_*.txt`: A human-readable text summary of the best performing model, feature set, and unmatched tower statistics.
*   `result/<context>/result_*.csv`: High-level metrics for all tested model candidates.
*   `result/<context>/*_distance_models_per_fold.csv`: Detailed metrics for every fold of cross-validation.
*   `result/<context>/*_model_params.csv`: **(NEW)** Averaged coefficients (mean ± std) for every model tested, enabling direct reuse.
*   `result/<context>/*_formula.json`: **(NEW)** A production-ready JSON file containing the best model's coefficients and formula description.

### Example `formula.json` Output
```json
{
  "context": "waha",
  "model": "I1 logd ~ rsrp + rsrq + earfcn_k + rsrp_x_earfcnk",
  "features": ["rsrp", "rsrq", "earfcn_k", "rsrp_x_earfcnk"],
  "coefficients": {
    "intercept": 0.9427,
    "coef_rsrp": -0.00038,
    "coef_rsrq": -0.0127,
    "coef_earfcn_k": 1.2255,
    "coef_rsrp_x_earfcnk": -0.00049
  },
  "notes": "earfcn_k = EARFCN / 1000. Interaction term: rsrp_x_earfcnk = rsrp * earfcn_k"
}
```